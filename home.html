<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home Page</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #fafafa;
            margin: 0;
            padding: 0;
        }
        .navbar {
            background-color: white;
            border-bottom: 1px solid #dbdbdb;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .navbar h1 {
            margin: 0;
            font-size: 24px;
            color: #262626;
        }
        .navbar .search-bar {
            display: flex;
            margin: 0 20px;
            flex: 1;
        }
        .navbar .search-bar input {
            flex: 1;
            padding: 10px;
            font-size: 16px;
            border: 1px solid #dddfe2;
            border-radius: 4px 0 0 4px;
            outline: none;
        }
        .navbar .search-bar button {
            padding: 10px 20px;
            font-size: 16px;
            border: 1px solid #dddfe2;
            border-left: none;
            border-radius: 0 4px 4px 0;
            background-color: #0095f6;
            color: white;
            cursor: pointer;
        }
        .navbar .search-bar button:hover {
            background-color: #007bb5;
        }
        .navbar .nav-icons {
            display: flex;
            align-items: center;
        }
        .navbar .nav-icons a, .navbar .nav-icons button {
            color: #262626;
            font-size: 20px;
            margin-left: 20px;
            background: none;
            border: none;
            cursor: pointer;
        }
        .container {
            max-width: 935px;
            margin: 20px auto;
            padding: 20px;
            background-color: white;
            border: 1px solid #dbdbdb;
            border-radius: 3px;
            display: flex;
        }
        .main-content {
            flex: 3;
        }
        .sidebar {
            flex: 1;
            margin-left: 20px;
        }
        .search-result {
            position: absolute;
            background-color: white;
            border: 1px solid #dddfe2;
            border-radius: 4px;
            width: calc(100% - 40px);
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
        }
        .search-result p {
            margin: 0;
            padding: 10px;
            cursor: pointer;
        }
        .search-result p:hover {
            background-color: #f0f2f5;
        }
        .friends-list {
            background-color: white;
            padding: 20px;
            border-radius: 3px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .friends-list h3 {
            margin: 0 0 10px 0;
            color: #262626;
        }
        .friends-list p {
            margin: 0;
            color: #262626;
            cursor: pointer;
        }
        .friends-list p:hover {
            text-decoration: underline;
        }
        .friend-requests {
            background-color: white;
            padding: 20px;
            border-radius: 3px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .friend-requests h3 {
            margin: 0 0 10px 0;
            color: #262626;
        }
        .friend-request {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .friend-request button {
            padding: 5px 10px;
            font-size: 14px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <h1>Mikxx</h1>
        <div class="search-bar">
            <input type="text" id="searchEmail" placeholder="Search by email">
            <button id="searchButton"><i class="fas fa-search"></i></button>
            <div id="searchResult" class="search-result"></div>
        </div>
        <div class="nav-icons">
            <a href="profile.html" id="profileLink"><i class="fas fa-user"></i></a>
            <button id="logoutButton"><i class="fas fa-sign-out-alt"></i></button>
        </div>
    </div>
    <div class="container">
        <div class="main-content">
            <h2>Welcome to Mikxx</h2>
            <p>Use the search bar to find friends and view their profiles.</p>
        </div>
        <div class="sidebar">
            <div class="friend-requests" id="friendRequests">
                <h3>Friend Requests</h3>
                <!-- Friend requests will be dynamically added here -->
            </div>
            <div class="friends-list" id="friendsList">
                <h3>Friends</h3>
                <!-- Friends will be dynamically added here -->
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="firebase.js"></script>
    <script>
        document.getElementById('logoutButton').addEventListener('click', () => {
            firebase.auth().signOut().then(() => {
                window.location.href = 'index.html'; // Redirect to login page
            }).catch((error) => {
                alert('Error: ' + error.message);
            });
        });

        document.getElementById('searchButton').addEventListener('click', () => {
            const email = document.getElementById('searchEmail').value;
            if (email) {
                searchUserByEmail(email);
            } else {
                alert('Please enter an email to search.');
            }
        });

        document.getElementById('searchEmail').addEventListener('input', () => {
            const email = document.getElementById('searchEmail').value;
            if (email) {
                searchUserByEmail(email);
            } else {
                document.getElementById('searchResult').innerHTML = '';
            }
        });

        function searchUserByEmail(email) {
            firebase.firestore().collection('users').where('email', '==', email).get()
                .then((querySnapshot) => {
                    const searchResult = document.getElementById('searchResult');
                    searchResult.innerHTML = '';
                    if (!querySnapshot.empty) {
                        querySnapshot.forEach((doc) => {
                            const userData = doc.data();
                            const resultItem = document.createElement('p');
                            resultItem.textContent = userData.email;
                            resultItem.addEventListener('click', () => {
                                openUserProfile(userData.email);
                            });
                            searchResult.appendChild(resultItem);
                        });
                    } else {
                        searchResult.innerHTML = `<p>No user found with email: ${email}</p>`;
                    }
                })
                .catch((error) => {
                    console.error("Error searching for user:", error);
                    alert('Error: ' + error.message);
                });
        }

        function openUserProfile(email) {
            window.location.href = `profile.html?email=${email}`;
        }

        function loadFriends() {
            const user = firebase.auth().currentUser;
            if (user) {
                firebase.firestore().collection('users').doc(user.email).get()
                    .then((doc) => {
                        if (doc.exists) {
                            const userData = doc.data();
                            const friendsList = document.getElementById('friendsList');
                            friendsList.innerHTML = '<h3>Friends</h3>';
                            if (userData.friends && userData.friends.length > 0) {
                                userData.friends.forEach((friendEmail) => {
                                    firebase.firestore().collection('users').doc(friendEmail).get()
                                        .then((friendDoc) => {
                                            if (friendDoc.exists) {
                                                const friendData = friendDoc.data();
                                                const friendItem = document.createElement('p');
                                                friendItem.textContent = friendData.email;
                                                friendItem.addEventListener('click', () => {
                                                    window.location.href = `profile.html?email=${friendData.email}`;
                                                });
                                                friendsList.appendChild(friendItem);
                                            }
                                        }).catch((error) => {
                                            console.error('Error fetching friend data:', error);
                                        });
                                });
                            } else {
                                friendsList.innerHTML += '<p>No friends added yet.</p>';
                            }
                        }
                    }).catch((error) => {
                        console.error('Error fetching user data:', error);
                    });
            }
        }

        function loadFriendRequests() {
            const user = firebase.auth().currentUser;
            if (user) {
                firebase.firestore().collection('friendRequests')
                    .where('receiver', '==', user.email)
                    .where('status', '==', 'pending')
                    .get()
                    .then((querySnapshot) => {
                        const friendRequests = document.getElementById('friendRequests');
                        friendRequests.innerHTML = '<h3>Friend Requests</h3>';
                        querySnapshot.forEach((doc) => {
                            const request = doc.data();
                            const requestElement = document.createElement('div');
                            requestElement.className = 'friend-request';
                            requestElement.innerHTML = `
                                <span>${request.sender}</span>
                                <div>
                                    <button onclick="acceptFriendRequest('${doc.id}')">Accept</button>
                                    <button onclick="rejectFriendRequest('${doc.id}')">Reject</button>
                                </div>
                            `;
                            friendRequests.appendChild(requestElement);
                        });
                    });
            }
        }

        function acceptFriendRequest(requestId) {
            const user = firebase.auth().currentUser;
            firebase.firestore().collection('friendRequests').doc(requestId).get()
                .then((doc) => {
                    const request = doc.data();
                    return firebase.firestore().runTransaction((transaction) => {
                        transaction.update(firebase.firestore().collection('friendRequests').doc(requestId), { status: 'accepted' });
                        transaction.update(firebase.firestore().collection('users').doc(user.email), {
                            friends: firebase.firestore.FieldValue.arrayUnion(request.sender)
                        });
                        transaction.update(firebase.firestore().collection('users').doc(request.sender), {
                            friends: firebase.firestore.FieldValue.arrayUnion(user.email)
                        });
                    });
                })
                .then(() => {
                    loadFriendRequests();
                    loadFriends();
                })
                .catch((error) => {
                    console.error('Error accepting friend request:', error);
                });
        }

        function rejectFriendRequest(requestId) {
            firebase.firestore().collection('friendRequests').doc(requestId).delete()
                .then(() => {
                    loadFriendRequests();
                })
                .catch((error) => {
                    console.error('Error rejecting friend request:', error);
                });
        }

        // Update the profile link to include the user's email
        firebase.auth().onAuthStateChanged((user) => {
            if (user) {
                document.getElementById('profileLink').href = `profile.html?email=${user.email}`;
                loadFriends();
                loadFriendRequests();
            } else {
                window.location.href = 'index.html'; // Redirect to login page if not signed in
            }
        });
    </script>
</body>
</html>